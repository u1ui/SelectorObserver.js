<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Tests</title>
    <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />

<body>
    <div id="mocha"></div>

    <script src="https://unpkg.com/chai/chai.js"></script>
    <script src="https://unpkg.com/mocha/mocha.js"></script>

    <script class="mocha-init">
        mocha.setup('bdd');
        mocha.checkLeaks();
    </script>

    <div class=container id=container>
        <div class=item id=el1>added before</div>
    </div>

    <script type=module>
    import {SelectorObserver} from '../SelectorObserver.js';

    describe('SelectorObserver', () => {
        let lastAdded = null;
        let lastRemoved = null;
        let o = new SelectorObserver({
            on: el => lastAdded = el ,
            off : el => lastRemoved = el ,
        });
        o.observe('.container .item', {checkAnimation: true, checkMutations:false});

        let el2 = document.createElement('div');
        el2.classList.add('item');
        el2.id = 'el2';

        it('found existing:', () => {
            chai.expect(lastAdded).to.equal(el1);
        });

        it('add dynamicly:', done => {
            lastAdded = lastRemoved = null;
            el1.after(el2)
            setTimeout(()=>{
                chai.expect(lastAdded).to.equal(el2);
                done();
            })
        });

        it('remove class:', done => {
            lastAdded = lastRemoved = null;
            el2.classList.remove('item');
            setTimeout(()=>{
                chai.expect(lastRemoved).to.equal(el2);
                done();
            })
        });

        it('nested, remove parent class: (should not work)', done => {
            lastAdded = lastRemoved = null;
            container.classList.remove('container');
            setTimeout(()=>{
                chai.expect(lastRemoved).to.equal(null);
                container.classList.add('container');
                done();
            });
        });

        it('add wrapped:', done => {
            lastAdded = lastRemoved = null;
            el1.insertAdjacentHTML('afterend', '<div id=wrapper><div class=item id=el2>wrapped</div></div>');
            setTimeout(()=>{
                chai.expect(lastAdded.id).to.equal('el2');
                done();
            })
        });

        it('remove wrapped:', done => {
            lastAdded = lastRemoved = null;
            wrapper.remove();
            setTimeout(()=>{
                chai.expect(lastRemoved.id).to.equal('el2');
                done();
            })
        });

        it('add after disconnect:', done => {
            lastAdded = lastRemoved = null;
            o.disconnect();
            el1.insertAdjacentHTML('afterend', '<div class=item id=afterDisconnect>after disconnect</div>');
            setTimeout(()=>{
                chai.expect(lastAdded).to.equal(null);
                afterDisconnect.remove();
                done();
            });
        });

    });



    describe('SelectorObserver check by animationend', () => {
        it('nested, add parent class:', done => {
            let o = new SelectorObserver({
                on: el => {
                    chai.expect(el.id).to.equal('el1');
                    done();
                }
            })
            o.observe('.test #el1:first-child', {checkAnimation: true});
            container.classList.add('test');
        });
    });

    </script>
    <script class="mocha-exec" type=module>
      mocha.run();
    </script>
</body>

</html>